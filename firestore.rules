
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Aturan umum untuk koleksi:
    // Secara default, tolak semua akses baca/tulis kecuali diizinkan secara eksplisit.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- KOLEKSI PUBLIK (BACA SAJA) ---

    // Produk, Blog, Acara, Testimoni, Menu dapat dibaca oleh siapa saja
    match /products/{productId} {
      allow read: if true;
    }
    match /blog/{postId} {
      allow read: if true;
    }
    match /events/{eventId} {
      allow read: if true;
    }
    match /testimonials/{testimonialId} {
      allow read: if true;
    }
    match /menu/{menuId} {
      allow read: if true;
    }
    
    // Pengaturan situs (hero, contact info) juga dapat dibaca oleh siapa saja
    match /siteContent/{docId} {
        allow read: if true;
    }
    match /settings/{docId} {
        allow read: if true;
    }


    // --- KOLEKSI PESANAN (ORDERS) ---
    // Aturan yang lebih ketat untuk data sensitif pengguna
    match /orders/{orderId} {
      
      // Siapa saja boleh menambahkan order sebagai guest (userId == null).
      // Aturan ini penting untuk checkout tanpa login.
      allow create: if request.resource.data.userId == null;

      // Pengguna yang login dapat membuat pesanan untuk dirinya sendiri.
      // `request.auth.uid` harus cocok dengan `userId` di dokumen baru.
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;

      // Pengguna yang login hanya dapat membaca pesanan miliknya.
      // Ini melindungi riwayat pesanan dari pengguna lain.
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      
      // Admin dapat membaca semua pesanan.
      // Ganti 'admin-email@example.com' dengan email admin Anda yang sebenarnya.
      allow read, write: if request.auth != null && request.auth.token.email in ['dev@sidepe.com', 'rd.lapawawoi@gmail.com'];


      // Memperbarui pesanan tidak diizinkan di sisi klien untuk menjaga integritas data.
      // Status pesanan harus diperbarui oleh backend/admin.
      allow update: if false;

      // Menghapus pesanan tidak diizinkan dari sisi klien.
      allow delete: if false;
    }
  }
}
